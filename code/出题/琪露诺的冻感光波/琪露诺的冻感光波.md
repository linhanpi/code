### 转化题意

一个平面合法当且仅当每行每列有且仅有 $2$ 只青蛙。

必要性显然，充分性容易构造证明。

转化为对每行每列都有两个位置为 $1$ 的 $01$ 矩阵数数。

### Sol 1

把矩阵看作一张二分图的邻接矩阵的形式，则满足条件的矩阵和由若干个环组成且每个点都有环连出的二分图构成双射。

设 $dp_n$ 表示 $n\times n$ 大小矩阵的答案，转移时枚举第一个左侧点所在环的大小

$$dp_n=\sum_{i=2,2|i}^n\begin{pmatrix}n\\i\end{pmatrix}\begin{pmatrix}n-1\\i-1\end{pmatrix}\dfrac{i!(i-1)!}{2}dp_{i}$$

组合数的意义是选出 $i-1$ 个左侧点和 $i$ 个右侧点，$\dfrac{i!(i-1)!}{2}$ 表示每边点数为 $i$ 的二分图构成环的个数。

化简一下

$$
\begin{aligned}
dp_{n}&=\sum_{i=2}^{n} \frac{n !}{i !(n-i) !} \frac{(n-1) !}{(i-1) !(n-i) !} \frac{i !(i-1) !}{2} dp_{n-i} \\
&=\sum_{i=2}^{n} \frac{n !(n-1) !}{2(n-1) !^{2}} dp_{n-i} \\
&=\frac{n !(n-1) !}{2} \sum_{i=2}^{n} \frac{dp_{n-i}}{(n-i) !^{2}}
\end{aligned}
$$

求出 $\dfrac{dp_n}{n^2}$ 的前缀和可以优化到 $\mathcal{O}(n)$。

### Sol 2

如果你不想线性预处理逆元的话……

重新转化题意：有 $n$ 个格子 $n$ 个操作，每次操作可以将两个不同的格子 $+1$，问最后所有格子数均为 $2$ 的操作方案数。

设 $dp_n$ 表示初始有 $n$ 个空格子的方案数，$g_n$ 表示初始有两个格子为 $1$ 其余为空的方案数。

$g_n$ 的转移考虑用一次操作改变最后一个有 $1$ 的位置，可以选出前面 $n-2$ 个位置中的一个与其操作转移到 $g_{n-1}$；或者选择两个为 $1$ 的位置转移到 $dp_{n-2}$，各有 $n-1$ 个操作可以选择。

$$g_n=(n-2)(n-1)g_{n-1}+(n-1)dp_{n-2}$$

$dp_n$ 的转移考虑选择前面 $(n-1)$ 个位置中的一个和最后一个位置操作把它们变成 $1$。

$$dp_n=\dfrac{(n-1)g_n}{2}$$

这里除以 $2$ 的原因是 $g_n$ 的转移中我们把应该算成 $\begin{pmatrix}n\\2\end{pmatrix}$ 的选择两个相同的位置对操作两次和对于一个位置选择两个不同的位置消去一个位置的方式算成了 $n(n-1)$。

时间复杂度 $\mathcal{O}(n)$。

不用预处理妮圆。
